name: Visuelstory

on:
  push:
    branches:
      - main
      - dev

jobs:
  prepare-job:
    name: Prepare
    runs-on: ubuntu-latest
    steps:
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          coverage: none
      - name: Checkout Code
        uses: actions/checkout@v5
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
      - name: Install Dependencies
        run: composer install -n --prefer-dist
      - name: Generate Key
        run: php artisan key:generate
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
      - name: Print Env Variables
        run: printenv
  deploy-job:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [prepare-job]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
      - name: Deploy using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          port: 65002
          script: |
            cd domains/api-visuel.superrayateknik.com/visuelstory-api
            git pull
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan migrate
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
  notify-job:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: [prepare-job, deploy-job]
    steps:
      - name: Send Notify Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ✅ **GitHub Action Status**

            👤 Actor: ${{ github.actor }}
            📦 Repository: ${{ github.repository }}
            🌿 Branch: ${{ github.ref_name }}

            🏗 Job ID: ${{ github.job }}
            🔍 Status: ${{ needs.prepare-job.result }}

            📝 Commit: ${{ github.event.commits[0].message }}
            🔗 [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
